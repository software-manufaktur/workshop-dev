<!doctype html>
<html lang="de">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Termin Manager</title>
  <link rel="icon" href="static/logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: '#A88C5D',
            dark: '#1F2937',
            soft: '#E5E7EB',
            mid: '#D1D5DB'
          }
        }
      }
    }
  </script>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#AF9778">

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Termin Manager">
  <link rel="apple-touch-icon" href="static/icons/logo.png">

  <style>
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>

<body class="text-slate-900">
  <div id="updateBanner" class="hidden bg-amber-100 text-amber-900 border-b border-amber-200 px-4 py-3 flex items-center gap-3 justify-between">
    <span>Update verfuegbar. Bitte neu laden.</span>
    <button id="btnReloadUpdate" class="px-3 py-1 rounded-lg bg-amber-600 text-white text-sm">Neu laden</button>
  </div>

  <header class="max-w-4xl mx-auto px-4 py-4">
    <div class="grid grid-cols-3 items-center">
      <div></div>
      <div class="justify-self-center flex items-center gap-3">
        <img id="brandLogo" src="static/logo.png" alt="Logo" class="h-10 w-auto relative z-10">
        <h1 id="brandTitle" class="text-xl font-semibold" style="color:#AF9778">Termin Manager</h1>
      </div>
      <div class="flex items-center gap-2 justify-self-end">
        <button id="btnMenu" class="sm:hidden p-2 rounded-xl bg-soft hover:bg-mid text-dark" aria-label="Menue">Menue</button>
        <div class="hidden sm:flex gap-2">
          <button id="btnManageSlots" class="px-3 py-2 rounded-xl bg-dark text-white hover:opacity-90 text-sm">Termin anlegen</button>
          <button id="btnExportCsv" class="px-3 py-2 rounded-xl bg-soft hover:bg-mid text-sm text-dark">CSV Export</button>
          <button id="btnBackup" class="px-3 py-2 rounded-xl bg-brand text-white hover:opacity-90 text-sm">Backup</button>
          <label for="fileRestore" class="px-3 py-2 rounded-xl bg-soft hover:bg-mid text-sm cursor-pointer text-dark">Wiederherstellen</label>
          <input type="file" id="fileRestore" accept="application/json" class="hidden">
          <button id="btnArchiveView" class="px-3 py-2 rounded-xl bg-soft hover:bg-mid text-sm text-dark">Archiv</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile-Menue -->
  <div id="mobileMenu" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" data-close="mobilemenu"></div>
    <div id="mobilePanel" class="absolute right-0 top-0 h-full w-[80%] max-w-xs bg-white shadow-2xl p-4 flex flex-col gap-3 translate-x-full transition-transform duration-200">
      <div class="flex items-center justify-between mb-2">
        <span class="text-lg font-semibold" style="color:#A88C5D">Menue</span>
        <button class="text-slate-500 hover:text-slate-700" data-close="mobilemenu">X</button>
      </div>
      <div class="text-xs uppercase tracking-wide text-slate-500">Hauptbereich</div>
      <button id="m_btnManageSlots" class="px-3 py-3 rounded-xl bg-soft text-left text-dark">Termin anlegen</button>
      <button id="m_btnExportCsv" class="px-3 py-3 rounded-xl bg-soft text-left text-dark">CSV Export</button>
      <button id="m_btnBackup" class="px-3 py-3 rounded-xl bg-soft text-left text-dark">Backup exportieren</button>
      <label for="m_fileRestore" class="px-3 py-3 rounded-xl bg-soft text-left cursor-pointer text-dark">Backup importieren</label>
      <input type="file" id="m_fileRestore" accept="application/json" class="hidden">
      <button id="m_btnArchiveView" class="px-3 py-3 rounded-xl bg-soft text-left text-dark">Archiv</button>
      <div class="text-xs uppercase tracking-wide text-slate-500 mt-4">Konto & Einstellungen</div>
      <button id="m_btnLogin" class="px-3 py-3 rounded-xl bg-soft text-left text-dark">Anmelden</button>
      <button id="m_btnLogout" class="px-3 py-3 rounded-xl bg-soft text-left text-dark hidden">Abmelden</button>
    </div>
  </div>

  <!-- Auth / Status -->
  <section class="max-w-4xl mx-auto px-4 space-y-2">
    <div class="flex flex-wrap gap-3 items-center text-sm">
      <div class="flex items-center gap-2">
        <span id="statusDot" class="font-bold text-emerald-600" aria-live="polite">O</span>
        <span id="syncMeta" class="text-slate-700">Zuletzt synchronisiert: -</span>
      </div>
      <div class="flex items-center gap-2 ml-auto">
        <span id="authStatus" class="text-slate-700">Nicht eingeloggt</span>
        <span id="cloudStatus" class="text-slate-600">Cloud-Sicherung: nicht angemeldet</span>
        <button id="btnLogout" type="button" class="px-3 py-2 rounded-xl bg-soft hover:bg-mid text-sm text-dark hidden">Abmelden</button>
      </div>
    </div>
    <div class="flex flex-wrap gap-3 items-center">
      <form id="authForm" class="flex flex-wrap gap-2 items-center">
        <input id="authEmail" type="email" required class="px-3 py-2 rounded-xl border border-graymid/60" placeholder="E-Mail fuer Magic Link">
        <button type="submit" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm">Anmelden</button>
      </form>
      <label class="flex items-center gap-2 text-sm">
        Konto/Team
        <select id="teamSelect" class="px-3 py-2 rounded-xl border border-graymid/60 min-w-[140px]">
          <option value="">Lokaler Modus</option>
        </select>
      </label>
    </div>
  </section>

  <!-- Suche + Filter -->
  <section class="max-w-4xl mx-auto px-4">
    <div class="grid grid-cols-1 sm:grid-cols-[1fr_auto] gap-3 my-3">
      <input id="search" class="w-full px-3 py-3 rounded-xl border border-mid/60 bg-white/90 backdrop-blur" placeholder="Suche nach Datum, Titel">
      <select id="filterStatus" class="px-3 py-3 rounded-xl border border-mid/60 bg-white/90 min-w-[120px]">
        <option value="">alle</option>
        <option value="open">offen</option>
        <option value="full">voll</option>
        <option value="past">vergangen</option>
        <option value="archived">archiv</option>
      </select>
    </div>
  </section>

  <!-- Slot-Liste -->
  <main class="max-w-4xl mx-auto px-4 pb-28" id="list"></main>

  <!-- Backups -->
  <section class="max-w-4xl mx-auto px-4 pb-10 space-y-4">
    <div class="bg-white/90 border border-gray-200 rounded-2xl p-4 shadow-sm">
      <h3 class="font-semibold mb-2" style="color:#A88C5D">Lokale Sicherungen (letzte 10)</h3>
      <ul id="localBackups" class="space-y-1 text-sm"></ul>
    </div>
    <details class="bg-white/90 border border-gray-200 rounded-2xl p-4 shadow-sm" open>
      <summary class="font-semibold cursor-pointer" style="color:#A88C5D">Einstellungen & Cloud</summary>
      <div class="text-sm text-slate-700 mt-2">Cloud-Sicherung l√§uft automatisch nach Login.</div>
      <h4 class="font-semibold mt-3">Cloud-Backups</h4>
      <ul id="serverBackups" class="space-y-1 text-sm"></ul>
      <div id="debugPanel" class="hidden text-xs text-slate-600 bg-yellow-50 border border-yellow-200 rounded-xl px-3 py-2 mt-3"></div>
    </details>
  </section>

  <!-- Modal: Buchung -->
  <div id="modalBooking" class="fixed inset-0 z-50 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-5" role="dialog" aria-modal="true">
      <div class="flex items-center justify-between mb-3">
        <h2 id="modalBookingTitle" class="text-lg font-semibold" style="color:#AF9778">Buchung</h2>
        <button data-close="booking" class="text-slate-500 hover:text-slate-700" aria-label="Schliessen">X</button>
      </div>
      <form id="formBooking" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <label class="flex flex-col gap-1">
          <span class="text-sm">Anrede</span>
          <select id="bk_salutation" class="px-3 py-2 rounded-xl border border-graymid/60">
            <option value="Liebe/r">Liebe/r</option>
            <option value="Liebe">Liebe</option>
            <option value="Lieber">Lieber</option>
          </select>
        </label>
        <label class="flex flex-col gap-1">
          <span class="text-sm">Name *</span>
          <input required type="text" id="bk_name" class="px-3 py-2 rounded-xl border border-graymid/60">
        </label>
        <label class="flex flex-col gap-1">
          <span class="text-sm">Telefon *</span>
          <input required type="tel" id="bk_phone" class="px-3 py-2 rounded-xl border border-graymid/60">
        </label>
        <label class="flex flex-col gap-1">
          <span class="text-sm">Personen *</span>
          <input required type="number" min="1" step="1" id="bk_count" class="px-3 py-2 rounded-xl border border-graymid/60" value="1">
        </label>
        <label class="flex flex-col gap-1">
          <span class="text-sm">Kontaktkanal</span>
          <select id="bk_channel" class="px-3 py-2 rounded-xl border border-graymid/60">
            <option value="">-</option>
            <option>Instagram</option>
            <option>WhatsApp</option>
            <option>E-Mail</option>
            <option>Triviar</option>
            <option>Telefonisch</option>
            <option>Persoenlich</option>
          </select>
        </label>
        <label class="md:col-span-2 flex flex-col gap-1">
          <span class="text-sm">Notiz</span>
          <textarea id="bk_notes" rows="3" class="px-3 py-2 rounded-xl border border-graymid/60"></textarea>
        </label>
        <div class="md:col-span-2 flex flex-col sm:flex-row gap-2">
          <button type="button" id="btnDeleteBooking" class="w-full sm:w-auto px-4 py-2 rounded-xl bg-rose-100 text-rose-700 hidden">Loeschen</button>
          <button type="button" id="btnWhatsappShare" class="w-full sm:w-auto px-4 py-2 rounded-xl bg-emerald-600 text-white hidden">WhatsApp</button>
          <button type="button" data-close="booking" class="w-full sm:w-auto px-4 py-2 rounded-xl bg-graysoft">Abbrechen</button>
          <button type="submit" class="w-full sm:w-auto px-4 py-2 rounded-xl text-white" style="background:#AF9778">Speichern</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Termin -->
  <div id="modalSlots" class="fixed inset-0 z-50 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-5" role="dialog" aria-modal="true">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold" style="color:#AF9778">Termin anlegen / bearbeiten</h2>
        <button data-close="slots" class="text-slate-500 hover:text-slate-700" aria-label="Schliessen">X</button>
      </div>
      <form id="formSlot" class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <label class="flex flex-col gap-1 md:col-span-2">
          <span class="text-sm">Kategorie</span>
          <select id="sl_category" class="px-3 py-2 rounded-xl border border-graymid/60">
            <option>Workshop</option>
            <option>Kindergeburtstag</option>
            <option>JGA</option>
            <option>Maedelsabend</option>
            <option>Weihnachtsfeier</option>
            <option>Sonstiges</option>
          </select>
        </label>
        <label class="flex flex-col gap-1 md:col-span-2" id="row_title_other" style="display:none">
          <span class="text-sm">Titel (bei Sonstiges)</span>
          <input type="text" id="sl_title_other" class="px-3 py-2 rounded-xl border border-graymid/60" placeholder="Eigener Titel">
        </label>
        <label class="flex flex-col gap-1">
          <span class="text-sm">Kapazitaet *</span>
          <input type="number" min="1" step="1" id="sl_capacity" class="px-3 py-2 rounded-xl border border-graymid/60" value="10" required>
        </label>
        <label class="flex flex-col gap-1">
          <span class="text-sm">Start *</span>
          <input type="datetime-local" id="sl_starts" class="px-3 py-2 rounded-xl border border-graymid/60" required>
        </label>
        <label class="flex flex-col gap-1">
          <span class="text-sm">Ende *</span>
          <input type="datetime-local" id="sl_ends" class="px-3 py-2 rounded-xl border border-graymid/60" required>
        </label>
        <div class="md:col-span-2 flex flex-col sm:flex-row gap-2">
          <button type="button" data-close="slots" class="w-full sm:w-auto px-4 py-2 rounded-xl bg-graysoft">Abbrechen</button>
          <button type="submit" class="w-full sm:w-auto px-4 py-2 rounded-xl text-white" style="background:#AF9778">Speichern</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Termin loeschen bestaetigen -->
  <div id="modalConfirmDelete" class="fixed inset-0 z-50 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
      <div class="flex items-start gap-3">
        <div class="text-2xl">!</div>
        <div>
          <h3 class="text-xl font-semibold mb-1 text-rose-700">Achtung</h3>
          <p class="text-slate-700">Termin wirklich loeschen? Alle zugehoerigen Buchungen werden ebenfalls geloescht.</p>
        </div>
      </div>
      <div class="mt-5 flex justify-end gap-2">
        <button id="btnCancelDelete" class="px-4 py-2 rounded-xl bg-graysoft">Abbrechen</button>
        <button id="btnConfirmDelete" class="px-4 py-2 rounded-xl bg-rose-600 text-white">Endgueltig loeschen</button>
      </div>
    </div>
  </div>

  <!-- Modal: Backup Import -->
  <div id="modalBackupImport" class="fixed inset-0 z-50 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
      <h3 class="text-lg font-semibold mb-2" style="color:#AF9778">Backup wiederherstellen</h3>
      <p class="text-sm text-slate-700 mb-4">Datei: <span id="importFileName" class="font-medium">-</span></p>
      <p class="text-sm text-slate-700 mb-4">Inhalt: <span id="importCounts" class="font-medium">-</span></p>
      <div class="flex justify-end gap-2">
        <button id="btnCancelImport" class="px-4 py-2 rounded-xl bg-graysoft">Abbrechen</button>
        <button id="btnConfirmImport" class="px-4 py-2 rounded-xl bg-emerald-600 text-white">Importieren</button>
      </div>
      <p class="text-xs text-slate-500 mt-3">Import uebernimmt alle Termine und Buchungen. Falls vorhanden, wird die aktive Organisation beibehalten.</p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur border border-gray-200 shadow-xl rounded-xl px-4 py-3 hidden">
    <span id="toastMsg" class="text-sm"></span>
    <a id="toastLink" href="#" target="_blank" class="ml-3 underline" style="color:#AF9778">Oeffnen</a>
  </div>

  <script>
    window.APP_CONFIG = {
      SUPABASE_URL: "https://mpgmsxkibyytdfaswpoa.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wZ21zeGtpYnl5dGRmYXN3cG9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MDc4MDUsImV4cCI6MjA4MTM4MzgwNX0.isQbD5QbXBAUGxJzz6Sb2VCZCVbjs5t8bOii0QTQZNE",
      BRAND_NAME: "Termin Manager",
      BRAND_COLOR: "#AF9778",
      BRAND_LOGO: "static/logo.png"
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.3/dist/umd/supabase.js" crossorigin="anonymous"></script>
  <script src="app.js?v=6"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').catch(console.error);
    }
  </script>
</body>

</html>
